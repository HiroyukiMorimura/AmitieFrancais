# 仏作文音声読み上げ機能 実装提案書

## 1. 概要

仏作文ドリル（`Composition.tsx`）において、正解のフランス語テキストを音声で読み上げる機能を追加します。正解表示時にスピーカーアイコンを表示し、クリックで音声再生を行います。

## 2. 技術選定

### 2.1 音声合成方式の比較

| 方式 | メリット | デメリット | 推奨度 |
|------|---------|-----------|--------|
| **Web Speech API (SpeechSynthesis)** | ✅ 追加ライブラリ不要<br>✅ フランス語対応<br>✅ オフライン動作可能<br>✅ 実装が簡単 | ⚠️ ブラウザ依存（品質差）<br>⚠️ 一部ブラウザで制限あり | ⭐⭐⭐⭐⭐ |
| Google Cloud Text-to-Speech | ✅ 高品質な音声 | ❌ APIキー必要<br>❌ コスト発生<br>❌ ネットワーク必須 | ⭐⭐ |
| Azure Text-to-Speech | ✅ 高品質な音声 | ❌ APIキー必要<br>❌ コスト発生<br>❌ ネットワーク必須 | ⭐⭐ |
| react-speech-kit | ✅ React統合 | ⚠️ 依存関係追加<br>⚠️ Web Speech APIのラッパー | ⭐⭐⭐ |

### 2.2 推奨方式：Web Speech API

**理由：**
- 追加の依存関係やAPIキーが不要
- フランス語（`fr-FR`）をサポート
- モダンブラウザで広く対応
- 実装がシンプルで保守しやすい

## 3. 実装設計

### 3.1 UI配置

**配置場所：** `Composition.tsx` の `DrillView` コンポーネント内

**現在のコード（706行目付近）：**
```tsx
<div className="mt-4 text-xl text-slate-700">{answer}</div>
```

**変更後：**
```tsx
<div className="mt-4 flex items-center justify-center gap-2">
  <div className="text-xl text-slate-700">{answer}</div>
  <button
    onClick={handleSpeak}
    className="flex items-center justify-center w-8 h-8 rounded-full hover:bg-slate-100 transition-colors"
    title="音声で聞く"
    aria-label="音声で聞く"
  >
    <svg className="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      {/* スピーカーアイコン */}
    </svg>
  </button>
</div>
```

### 3.2 音声読み上げ機能の実装

#### 3.2.1 カスタムフックの作成

**ファイル：** `src/hooks/useTextToSpeech.ts`

```typescript
import { useRef, useCallback } from 'react';

type UseTextToSpeechOptions = {
  lang?: string;
  rate?: number;
  pitch?: number;
  volume?: number;
};

export function useTextToSpeech(options: UseTextToSpeechOptions = {}) {
  const {
    lang = 'fr-FR',
    rate = 1.0,
    pitch = 1.0,
    volume = 1.0,
  } = options;

  const utteranceRef = useRef<SpeechSynthesisUtterance | null>(null);

  const speak = useCallback(
    (text: string) => {
      // 既存の読み上げを停止
      if (utteranceRef.current) {
        window.speechSynthesis.cancel();
      }

      // ブラウザサポートチェック
      if (!('speechSynthesis' in window)) {
        console.warn('Speech synthesis is not supported in this browser.');
        return;
      }

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = lang;
      utterance.rate = rate;
      utterance.pitch = pitch;
      utterance.volume = volume;

      utteranceRef.current = utterance;

      window.speechSynthesis.speak(utterance);
    },
    [lang, rate, pitch, volume]
  );

  const stop = useCallback(() => {
    window.speechSynthesis.cancel();
    utteranceRef.current = null;
  }, []);

  const isSupported = typeof window !== 'undefined' && 'speechSynthesis' in window;

  return { speak, stop, isSupported };
}
```

#### 3.2.2 Composition.tsx への統合

**変更箇所：**
1. `useTextToSpeech` フックのインポート
2. `DrillView` コンポーネント内でフックを使用
3. スピーカーアイコンボタンの追加とイベントハンドラ

**実装例：**
```tsx
// DrillView コンポーネント内
const { speak, isSupported } = useTextToSpeech({ lang: 'fr-FR' });

const handleSpeak = () => {
  if (card && isSupported) {
    speak(card.fr);
  }
};
```

### 3.3 スピーカーアイコンのデザイン

**アイコン：** Heroicons または SVG インライン

**推奨デザイン：**
- サイズ：20px × 20px（`w-5 h-5`）
- 色：`text-slate-600`（ホバー時：`text-slate-800`）
- 背景：ホバー時に `bg-slate-100` を表示
- 形状：円形ボタン（`rounded-full`）

**SVG コード例：**
```tsx
<svg
  className="w-5 h-5 text-slate-600"
  fill="none"
  stroke="currentColor"
  viewBox="0 0 24 24"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    strokeLinecap="round"
    strokeLinejoin="round"
    strokeWidth={2}
    d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"
  />
</svg>
```

### 3.4 エラーハンドリングとフォールバック

**考慮事項：**
1. **ブラウザサポートチェック**
   - `speechSynthesis` が利用できない場合、ボタンを非表示または無効化

2. **読み上げ中の状態管理**
   - 読み上げ中はアイコンを変更（例：停止アイコン）またはローディング表示

3. **エラーメッセージ**
   - 読み上げ失敗時にユーザーに通知（オプション）

## 4. 実装手順

### ステップ1: カスタムフックの作成
1. `src/hooks/useTextToSpeech.ts` を作成
2. `useTextToSpeech` フックを実装

### ステップ2: Composition.tsx の修正
1. `useTextToSpeech` をインポート
2. `DrillView` コンポーネント内でフックを使用
3. 正解表示部分にスピーカーアイコンボタンを追加
4. クリックイベントハンドラを実装

### ステップ3: スタイリング
1. Tailwind CSS クラスでスタイリング
2. ホバー効果とトランジションを追加
3. アクセシビリティ属性（`aria-label`）を追加

### ステップ4: テスト
1. ブラウザでの動作確認（Chrome, Firefox, Safari, Edge）
2. フランス語テキストの読み上げ品質確認
3. モバイルデバイスでの動作確認

## 5. ファイル構成

```
src/
├── hooks/
│   └── useTextToSpeech.ts          # 新規作成
└── pages/
    └── Composition.tsx              # 修正
```

## 6. 技術仕様

### 6.1 Web Speech API パラメータ

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| `lang` | `'fr-FR'` | フランス語（フランス） |
| `rate` | `1.0` | 読み上げ速度（0.1〜10.0） |
| `pitch` | `1.0` | 音の高さ（0.0〜2.0） |
| `volume` | `1.0` | 音量（0.0〜1.0） |

### 6.2 ブラウザサポート

| ブラウザ | サポート状況 |
|---------|------------|
| Chrome | ✅ 完全サポート |
| Firefox | ✅ 完全サポート |
| Safari | ✅ 完全サポート（iOS 7+） |
| Edge | ✅ 完全サポート |

## 7. 拡張可能性

### 7.1 将来的な拡張案

1. **読み上げ速度の調整**
   - UI にスライダーを追加して速度を変更可能にする

2. **複数言語対応**
   - 他の言語（英語、スペイン語など）にも対応

3. **読み上げ状態の可視化**
   - 読み上げ中はアイコンをアニメーション表示

4. **音声品質の向上**
   - 外部API（Google Cloud TTS等）へのフォールバック

## 8. 注意事項

1. **ユーザー操作の必要性**
   - 一部ブラウザでは、ユーザー操作（クリック等）をトリガーにしないと音声再生がブロックされる場合がある
   - 本実装ではボタンクリックで発火するため問題なし

2. **パフォーマンス**
   - 長文の読み上げ時は、キャンセル機能を提供することを推奨

3. **アクセシビリティ**
   - `aria-label` を適切に設定
   - キーボード操作にも対応（`tabindex` と `Enter` キー）

## 9. まとめ

本提案では、**Web Speech API** を使用したシンプルで保守しやすい実装を推奨します。追加の依存関係やAPIキーが不要で、モダンブラウザで広くサポートされており、フランス語の音声合成にも対応しています。

実装は以下の2ファイルの変更で完了します：
- `src/hooks/useTextToSpeech.ts`（新規作成）
- `src/pages/Composition.tsx`（修正）

この実装により、ユーザーは正解のフランス語を音声で確認でき、発音学習の効果が向上します。

